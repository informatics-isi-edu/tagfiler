$def with (tvars)
$ title = tvars.get('title')
$ apptarget = tvars.get('apptarget')
$ tagspace = tvars.get('tagspace')
$ data_id = tvars.get('data_id')
$ taginfo = tvars.get('taginfo')
$ typenames = tvars.get('typenames')
$ urlquote = tvars.get('urlquote')
$ idquote = tvars.get('idquote')
$ roleinfo = tvars.get('roleinfo')
$ tagnames = tvars.get('tagnameinfo')
$ allroles = roleinfo
$ excludes, tagdefs, tagdefsdict, tags, filetagvals, length = taginfo
$ tagvals = dict( [ (tag, vals) for file, tag, vals in filetagvals ] )
$ excludes = [ x for x in excludes ]
$ odd = True
$if title == 'User' and data_id:
	<p><a href="${apptarget + '/file/' + urlquote(data_id)}">Link to ${data_id}</a></p>
$if title != '':
	<h2>${title}</h2>
$if len(tagdefs) > 0:
	<table class="file-list">
	<tr class="file-heading">
	<th class="tag-name">Tag name</th>
	<th class="file-tags">Current Value(s)</th>
	</tr>
	$for tagdef in tagdefs:
		$ tag, typestr, writeok = tagdef
		$ tagname, typestr, writeok = tagdefsdict[tag]
		$ vals = tagvals.get(tagname, None)
		$if odd:
			<tr class="file odd">
		$else:
			<tr class="file even">
		$ odd = not odd
		<td class="tag name">${tagname}</td>
		<td class="file-tag ${idquote(tagname)}">
		$if typestr:
			<table class="file-tag-list">
			$if vals == None:
				$ itervals = []
			$else:
				$ itervals = vals
			$for val in itervals:
				<tr>
				<td class="file-tag ${idquote(tag)} multivalue">${val}</td>
				<form enctype="application/x-www-form-urlencoded" action="${apptarget}/${tagspace}/${urlquote(data_id)}" method="post">
				<input type="hidden" name="tag" value="${tag}" />
				<input type="hidden" name="value" value="${val}" />
				<td class="file-tag ${idquote(tag)} multivalue delete">
				$if writeok:
					<input type="hidden" name="action" value="delete" />
					<input type="submit" value="Remove Value" />
				</td>
				</form>
			 	</tr>
			$if writeok:
				<tr>
				<form enctype="application/x-www-form-urlencoded" action="${apptarget}/${tagspace}/${urlquote(data_id)}" method="post">
				<input type="hidden" name="set-${urlquote(tagname)}" value="true" />
				<td class="file-tag ${idquote(tagname)} multivalue input">
				$if typestr in ['role', 'tagname']:
					$if typestr == 'role':
						$if allroles != None:
							$ options = [ role for role in set(allroles).difference(set(tagvals.get(tagname, []))) ]
						$else:
							$ options = []
					$elif typestr == 'tagname':
						$ options = [ tag for tag in set(tagnames).difference(set(tagvals.get(tagname, []))) ]
					$else:
						$ options = []
					$if options:
						$ options.sort()
						<select name="val-${urlquote(tagname)}">
						<option value="">Choose a ${typestr}</option>
						$for option in options:
							<option value="${option}">${option}</option>
						</select>
					$else:
						<input type="text" name="val-${urlquote(tagname)}" />
				$else:
					<input type="text" name="val-${urlquote(tagname)}" />
				</td>
				<input type="hidden" name="action" value="put" />
				<td class="file-tag ${idquote(tagname)} multivalue set">
				<input type="submit" value="Set Value" />
				</td>
				</form>
				</tr>
			</table>
		$else:
			<form enctype="application/x-www-form-urlencoded" action="${apptarget}/${tagspace}/${urlquote(data_id)}" method="post">
			<input type="hidden" name="tag" value="${tag}" />
			$if writeok:
				$if vals != None:
					${tag} is set
					<input type="hidden" name="action" value="delete" />
					<input type="submit" value="Remove Tag" />
				$else:
					not set
					<input type="hidden" name="action" value="put" />
					<input type="submit" value="Set Tag" />
			</form>
		</td>
		</tr>
	</table>
$elif data_id:
	<p>There are no existing tags on "${data_id}".</p>
$else:
	<p>There are no existing tags in the catalog.</p>
