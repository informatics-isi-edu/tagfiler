$def with (file, tagdef, writetags, version, showversions=False)
$ writetags = [ tag for tag in writetags ]
$ tagnames = tagdefsdict.iterkeys()
$ typesdict = dict( [ (type['typedef'], type) for type in typeinfo ] )
$ type = typesdict[tagdef.typestr]
$ typename = type['typedef description']
$ typevals = type['typedef values']
$ writeok = tagdef.get('writeok', False)
$ vals = file[tagdef.tagname]
$ vsuffix = ''
$if version:
	$ vsuffix = '@%s' % version
$if vals == None:
	$ itervals = []
$else:
	$if tagdef.multivalue:
		$ itervals = vals
	$else:
		$ itervals = [ vals ]
$if writeok == None:
	$# writeok depends on file, e.g. is not statically determined
	$if tagdef.writepolicy == 'fowner':
		$ writeok = file.owner and file.owner in authn.roles
	$else:
		$# writepolicy == 'file'
		$ writeok = file.writeok
$ options = tagOptions(tagdef.tagname, itervals)
$ params = dict( filerecord=file,
$				 tagname=tagdef.tagname, 
$				 typestr=tagdef.typestr, 
$				 typename=typename, 
$				 typevals=typevals, 
$				 vsuffix=vsuffix, 
$				 vals=vals, 
$				 options=options,
$				 name='%s%s' % ('val-', urlquote(tagdef.tagname)),
$				 writeok=writeok,
$				 showversions=showversions)
$if tagdef.typestr != 'empty':
	$if len(itervals) > 0:
		<table class="file-tag-list">
		$for val in itervals:
			<tr>
			$ params['val'] = val
			$:{render.TagValueForm(params)}
			<td class="file-tag ${idquote(tagdef.tagname)} multivalue delete">
			$if tagdef.tagname in writetags and writeok:
				$:{render.RemoveTagValueForm(params)}
			</td>
			</tr>
		$if tagdef.tagname in writetags and writeok:
			$:{render.SetTagValueForm(params)}
		</table>
$else:
	$:{render.SetTagForm(params)}
