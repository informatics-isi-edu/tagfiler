$def with (file, tagdef, writetags, version)
$ writetags = [ tag for tag in writetags ]
$ tagnames = tagdefsdict.iterkeys()
$ typesdict = dict( [ (type['typedef'], type) for type in typeinfo ] )
$ type = typesdict[tagdef.typestr]
$ typename = type['_type_description']
$ typevals = type['_type_values']
$ writeok = tagdef.get('writeok', True)
$ vals = file[tagdef.tagname]
$ vsuffix = ''
$if version:
	$ vsuffix = '@%s' % version
$if vals == None:
	$ itervals = []
$else:
	$if tagdef.multivalue:
		$ itervals = vals
	$else:
		$ itervals = [ vals ]
$ options = tagOptions(tagdef.tagname, itervals)
$ params = dict( file=file.file, 
$				 tagname=tagdef.tagname, 
$				 typestr=tagdef.typestr, 
$				 typename=typename, 
$				 typevals=typevals, 
$				 vsuffix=vsuffix, 
$				 vals=vals, 
$				 options=options,
$				 name='%s%s' % ('val-', urlquote(tagdef.tagname)),
$				 writeok=writeok)
$if tagdef.typestr and tagspace=='tagdefacl' and ((tagdef.tagname=='readers' and file.readpolicy!='tag') or (tagdef.tagname=='writers' and file.writepolicy!='tag')):
	<!-- tagdef ${file.file} does not have ${tagdef.tagname} ACL. -->
$elif tagdef.typestr:
	<table class="file-tag-list">
	$for val in itervals:
		<tr>
		$ params['val'] = val
		$:{render.TagValueForm(params)}
		<td class="file-tag ${idquote(tagdef.tagname)} multivalue delete">
		$if tagdef.tagname in writetags and writeok:
			$:{render.RemoveTagValueForm(params)}
		</td>
		</tr>
	$if tagdef.tagname in writetags and writeok:
		$:{render.SetTagValueForm(params)}
	</table>
$else:
	$:{render.SetTagForm(params)}
