$def with (file, tagdef, writetags, version, showversions=False)
$if None:
	$# 
	$# Copyright 2010 University of Southern California
	$# 
	$# Licensed under the Apache License, Version 2.0 (the "License");
	$# you may not use this file except in compliance with the License.
	$# You may obtain a copy of the License at
	$# 
	$#    http://www.apache.org/licenses/LICENSE-2.0
	$# 
	$# Unless required by applicable law or agreed to in writing, software
	$# distributed under the License is distributed on an "AS IS" BASIS,
	$# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	$# See the License for the specific language governing permissions and
	$# limitations under the License.
	$#
$if writetags:
	$ writetags = [ tag for tag in writetags ]
$else:
	$ writetags = []
$ tagnames = tagdefsdict.iterkeys()
$ typesdict = dict( [ (type['typedef'], type) for type in typeinfo ] )
$ type = typesdict[tagdef.typestr]
$ typename = type['typedef description']
$ typevals = type['typedef values']
$ vals = file[tagdef.tagname]
$ vsuffix = ''
$if version:
	$ vsuffix = '@%s' % version
$if vals == None:
	$ itervals = []
$else:
	$if tagdef.multivalue:
		$ itervals = vals
	$else:
		$ itervals = [ vals ]
$ writeok = tagdef.writeok
$if file['write users'] == None:
	$ file['write users'] = []
$if writeok == None:
	$if tagdef.writepolicy == 'fowner':
		$ writeok = file.owner in authn.roles
	$elif tagdef.writepolicy == 'file':
		$ writeok = file.owner in authn.roles or len( set(authn.roles).intersection(set(file['write users'])) ) > 0
$ options = tagOptions(tagdef.tagname, itervals)
$ params = dict( filerecord=file,
$				 tagname=tagdef.tagname, 
$				 typestr=tagdef.typestr, 
$				 typename=typename, 
$				 typevals=typevals, 
$				 vsuffix=vsuffix, 
$				 vals=vals, 
$				 options=options,
$				 name='%s%s' % ('val-', urlquote(tagdef.tagname)),
$				 writeok=writeok,
$				 showversions=showversions)
$if tagdef.typestr != 'empty':
	<table class="file-tag-list">
	$if len(itervals) > 0:
		$for val in itervals:
			<tr>
			$ params['val'] = val
			$if smartTagValues:
				$:{render.TagValueForm(params)}
				<td class="file-tag ${idquote(tagdef.tagname)} multivalue delete">
				$if tagdef.tagname in writetags and writeok:
					$:{render.RemoveTagValueForm(params)}
				</td>
			$else:
				<td class="file-tag ${idquote(tagdef.tagname)} multivalue">${val}</td>
			</tr>
	$if smartTagValues and tagdef.tagname in writetags and writeok:
		$:{render.SetTagValueForm(params)}
	</table>
$else:
	$if smartTagValues:
		$:{render.SetTagForm(params)}
	$else:
		${vals}
