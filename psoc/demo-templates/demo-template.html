$def with ()
$ q_experiment = 'experimentID(experimentID;start;mice;principal;write%%20users)'
$ q_mouse = 'mouseID(mouseID;experiment;cage;%%23cells;cell%%20type;dob;dos;start;mouse%%20label;mouse%%20strain;samples;treatments;observations;write%%20users)'
$ q_sample = 'sampleID(sampleID;experiment;mouse;sample%%20type;start;observations;performer;write%%20users)'
$ q_observation = 'observationID(observationID;experiment;mouse;start;comment;performer;write%%20users)'
$ q_treatment = 'treatmentID(treatmentID;experiment;mouse;dose;drug;start;performer;write%%20users)'
$ experiments = dict([ (exp.experimentID, exp) for exp in template_query_results[q_experiment] ])
$ mice = dict([ (mouse.mouseID, mouse) for mouse in template_query_results[q_mouse] ])
$ samples = dict([ (samp.sampleID, samp) for samp in template_query_results[q_sample] ])
$ observations = dict([ (obsv.observationID, obsv) for obsv in template_query_results[q_observation] ])
$ treatments = dict([ (treat.treatmentID, treat) for treat in template_query_results[q_treatment] ])

$# weird bug workaround for template engine
$for x in [ 0 ]:
$code
	def showent(storage, keys=None):
            s = ''
            if keys == None:
                keys = storage.keys()
            s += '<ul>'
            for key in keys:
                s += '<li>%s: %s</li>' % (key, storage[key])
            s += '</ul>'
            return s
        # maintain indent level
        def style(key, hidden=[]):
            if key in hidden:
                return 'style="display: none" '
            else:
                return 'style="white-space: normal"'
        # maintain indent level
        def showsample(sample):
            s = '%s:&nbsp;%s' % (sample['start'], sample['sample type'])
            if sample.observations:
                s += ' (%s)' % (','.join([ '"%s"' % observations[observationID].comment for observationID in sample.observations ]))
            return s
        # maintain indent level
        def showtreatment(treatment):
            return '%s:&nbsp;%s&nbsp;mg/kg&nbsp;%s' % (treatment.start, treatment.dose, treatment.drug)
        # maintain indent level
        def showobservation(observation):
            return '%s: %s' % (observation.start, observation.comment)
        # maintain indent level
        def showval(storage, key):
            if key == 'id':
                return '%s' % storage.id
            elif key == 'treatments' and storage[key]:
                treats = [ treatments[treatmentID] for treatmentID in storage[key] ]
                treats.sort(key=lambda treatment: (treatment.start))
                return '<br />'.join([ showtreatment(treatment) for treatment in treats ])
            elif key == 'observations' and storage[key]:
                obsvs = [ observations[observationID] for observationID in storage[key] ]
                obsvs.sort(key=lambda observation: (observation.start))
                return '<br />'.join([ showobservation(observation) for observation in obsvs ])
            elif key == 'samples' and storage.samples:
                samps = [ samples[sampleID] for sampleID in storage.samples  ]
                samps.sort(key=lambda sample: (sample.start))
                return '<br />'.join([ showsample(sample) for sample in samps ])
            elif storage[key]:
                return "%s" % storage[key]

<h2>Experiments</h2>
$ keys = ['experimentID', 'start', 'principal', 'mice' ]
$ hidden = [ 'mice' ]
$ odd = True
<table class="file-list">
        <tr>
                $for key in keys:
                        <th class="file-tag ${idquote(key)}" ${style(key, hidden)}>$:{key.replace(" ", "&nbsp;")}</th>
        </tr>
$ experimentslist = experiments.values()
$ experimentslist.sort(key=lambda experiment: experiment.experimentID)
$for experiment in experimentslist:
        <tr>
                $for key in keys:
                        <td class="file-tag ${idquote(key)}" ${style(key, hidden)}>
                        $:{showval(experiment, key)}
                        </td>
        </tr>
</table>

<h2>Mice</h2>
$ keys = ['experiment', 'mouseID', 'mouse label', 'cage', 'dob', 'dos', 'start', 'mouse strain', 'cell type', '#cells', 'treatments', 'samples', 'observations' ]
$ hidden = []
$ odd = True
<table class="file-list">
        <tr>
                $for key in keys:
                        <th class="file-tag ${idquote(key)}" ${style(key, hidden)}>$:{key.replace(" ", "&nbsp;")}</th>
        </tr>
$ micelist = mice.values()
$ micelist.sort(key=lambda mouse: (mouse.experiment, mouse.mouseID))
$for mouse in micelist:
        <tr>
                $for key in keys:
                        <td class="file-tag ${idquote(key)}" ${style(key, hidden)}>
                        $:{showval(mouse, key)}
                        </td>
        </tr>
</table>

