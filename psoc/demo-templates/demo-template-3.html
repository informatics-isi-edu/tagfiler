$def with ()
$# weird bug workaround for template engine
$for x in [ 0 ]:
$code
	q_experiment = 'experimentID(experimentID;start;mice;principal;write%%20users)'
        q_mouse = 'mouseID(mouseID;experiment;cage;%%23cells;cell%%20type;dob;dos;start;mouse%%20label;mouse%%20strain;samples;treatments;observations;write%%20users)'
        q_sample = 'sampleID(sampleID;experiment;mouse;sample%%20type;serum%%20sample%%20type;start;observations;performer;write%%20users)'
        q_observation = 'observationID(observationID;experiment;mouse;start;comment;performer;write%%20users)'
        q_treatment = 'treatmentID(treatmentID;experiment;mouse;dose;drug;start;performer;write%%20users)'
        # maintain indent level
        def remap(storage, mapcols={}):
            for key in mapcols.keys():
                if tagdefsdict[key].multivalue:
                    if storage[key]:
                        storage[key] = [ mapcols[key][val] for val in storage[key] if mapcols[key].has_key(val) ]
                    else:
                        storage[key] = []
                else:
                    storage[key] = mapcols[key].get(storage[key], None)
            return storage
        # maintain indent level
        treatments = dict([ (treat.treatmentID, treat) for treat in template_query_results[q_treatment] ])
        observations = dict([ (obsv.observationID, obsv) for obsv in template_query_results[q_observation] ])
        samples = dict([ (samp.sampleID, remap(samp, { 'observations' : observations })) 
                         for samp in template_query_results[q_sample] ])
        mice = dict([ (mouse.mouseID, remap(mouse, { 'observations' : observations,
                                                     'samples' : samples,
                                                     'treatments' : treatments }))
                                            for mouse in template_query_results[q_mouse] ])
        # maintain indent level
        def summarize(experiment):
            dates = set()
            for mouse in experiment.mice:
                if mouse.samples:
                    for sample in mouse.samples:
                        dates.add(sample.start)
                else:
                    mouse['samples'] = []
                if mouse.observations:
                    for observation in mouse.observations:
                        dates.add(sample.start)
                else:
                    mouse['observations'] = []
                if mouse.treatments:
                    for treatment in mouse.treatments:
                        dates.add(treatment.start)
                else:
                    mouse['treatments'] = []
            dates = [ d for d in dates ]
            dates.sort()
            experiment['dates'] = dates 
            return experiment
        # maintain indent level
        experiments = dict([ (exp.experimentID, summarize(remap(exp, { 'mice' : mice }))) for exp in template_query_results[q_experiment] ])
        max_num_dates = max([ len(e.dates) for e in experiments.values() ] + [ 0 ] )
        # maintain indent level
        def style(key, hidden=[]):
            if key in hidden:
                return 'style="display: none" '
            else:
                return 'style="white-space: normal"'
        # maintain indent level
        def showsample(sample):
            s = '%s' % sample['sample type']
            if sample['serum sample type']:
                s+= ', %s' % sample['serum sample type']
            if sample.observations:
                s += ' (%s)' % (','.join([ '"%s"' % observations[observationID].comment for observationID in sample.observations ]))
            return '<a href="%s/subject/sampleID=%s">%s</a>' % (home, urlquote(sample.sampleID), s)
        # maintain indent level
        def showtreatment(treatment):
            return '<a href="%s/subject/treatmentID=%s">%s, %s mg/kg</a>' % (home, urlquote(treatment.treatmentID), treatment.drug, treatment.dose)
        # maintain indent level
        def showobservation(observation):
            return '<a href="%s/subject/observationID=%s">%s</a>' % (home, urlquote(observation.observationID), observation.comment)
        def showmouseID(mouseID):
            return '<a href="%s/subject/mouseID=%s">%s</a>' % (home, urlquote(mouseID), mouseID)
        # maintain indent level
        def mousevaleq(m1, m2, key):
            if key == 'treatments':
                return reduce(lambda x, y: x and y, 
                              map(lambda x, y: mousevaleq(x, y, 'dose') and mousevaleq(x, y, 'drug'),
                                  m1['treatments'] or [],
                                  m2['treatments'] or []),
                              True)
            else:
                return m1[key] == m2[key]
        # maintain indent level
        def makemergemap(mice, mergekeys):
            mergemap = dict()
            for key in mergekeys:
                groups = []
                base = 0
                for i in range(0, len(mice)):
                    if not mousevaleq(mice[i], mice[base], key):
                        groups.append( (base, i-base) )
                        base = i
                groups.append( (base, len(mice)-base) )
                mergemap[key] = dict(groups)
            return mergemap
        # maintain indent level
        pass
$def showval(experiment, m, key, mergemap):
    $if mergemap.has_key(key):
        $ count = mergemap[key].get(m, None)
    $else:
        $ count = 1
    $if count != None:
        $if experiment.mice[m][key]:
            <td rowspan="${count}" class="file-tag ${idquote(key)}">
            $if key == 'mouseID':
            	${showmouseID(experiment.mice[m][key])}
            $else:
                ${experiment.mice[m][key]}
            </td>
        $else:
            <td rowspan="${count}" class="file-tag ${idquote(key)}" />
<h2>Inventory</h2>
$ exp_cols = [ 'experiment' ]
$ exp_keys = [ 'experimentID' ]
$ mouse_cols = [ 'mouse', 'label', 'strain', 'cell type', '#cells', 'cage', 'dob', 'dos' ]
$ mouse_keys = [  'mouseID', 'mouse label', 'mouse strain', 'cell type', '#cells', 'cage', 'dob', 'dos' ]
$# merge_keys = [ 'mouse strain', 'dob', 'cell type', '#cells', 'treatments', 'cage', 'dos', 'mouse label' ]
$ merge_keys = []
<table class="file-list">
<thead>
<tr>
$for label in exp_cols:
	<th class="file-tag ${idquote(label)}">${label}</th>
<th class="file-tag" colspan="${len(mouse_cols)}">mouse</th>
<th colspan="${max_num_dates+1}" class="file-tag date">events</th>
</tr>
</thead>
<tbody>
$ exp_list = experiments.values()
$ exp_list.sort(key=lambda e: e.experimentID)
$for experiment in exp_list:
	$ odd = True
        $ rowclass = ''
	$if not experiment.mice:
        	$ experiment['mice'] = []
        $ experiment.mice.sort(key=lambda m: m.id)
        $ mergemap = makemergemap(experiment.mice, merge_keys)
	<tr class="file-tag${rowclass}">
        $for key in exp_keys:
        	<th rowspan="${len(experiment.mice)+1}" class="file-tag ${idquote(key)}"><a href="${home}/subject/experimentID=${urlquote(experiment.experimentID)}">${experiment[key]}</a></th>
        $for label in mouse_cols:
        	<th class="file-tag ${idquote(label)}">${label}</th>
        $ no_dates = [ x for x in treatments.values() if x.start == None ] + [ x for x in samples.values() if x.start == None ] + [ x for x in observations.values() if x.start == None ]
        $if len(no_dates) == 0:
        	$ no_dates_style='style="display: none"'
        $else:
        	$ no_dates_style=''
        <th class="file-tag date" ${no_dates_style}>no date</th>
       	$for i in range(0, len(experiment.dates)):
               	<th class="file-tag date">${experiment.dates[i]}</th>
        $for i in range(0, max_num_dates - len(experiment.dates)):
        	<th />
        </tr>
        $for m in range(0, len(experiment.mice)):
        	$ odd = not odd
                $if odd:
                	$ rowclass = ''
                $else:
                	$ rowclass = ''
		$ mouse = experiment.mice[m]
        	<tr class="file-tag${rowclass}">
                $for key in mouse_keys:
               		$:{showval(experiment, m, key, mergemap)}
               	$ sep = ''
               	<td class="file-tag date" ${no_dates_style}>
                $for x in [ x for x in mouse.treatments if x.start == None ]:
                       	${sep}$:{showtreatment(x)}
                        $ sep = '<br />'
                $for x in [ x for x in mouse.samples if x.start == None ]:
                       	${sep}$:{showsample(x)}
                        $ sep = '<br />'
                $for x in [ x for x in mouse.observations if x.start == None ]:
                       	${sep}$:{showobservation(x)}
                        $ sep = '<br />'
                </td>
         	$for i in range(0, len(experiment.dates)):
                	$ d = experiment.dates[i]
                	$ sep = ''
                	<td class="file-tag date">
                        $for x in [ x for x in mouse.treatments if x.start == d ]:
                        	${sep}$:{showtreatment(x)}
                                $ sep = '<br />'
                        $for x in [ x for x in mouse.samples if x.start == d ]:
                        	${sep}$:{showsample(x)}
                                $ sep = '<br />'
                        $for x in [ x for x in mouse.observations if x.start == d ]:
                        	${sep}$:{showobservation(x)}
                                $ sep = '<br />'
                        </td>
        	$for i in range(0, max_num_dates - len(experiment.dates)):
                	<td />
        	</tr>
</tbody>
</table>
